<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Joc ‚Äì Viatge Musical</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #283048, #859398);
      color: white;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .question-container {
      background-color: rgba(0, 0, 0, 0.3);
      padding: 2rem;
      border-radius: 10px;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      margin: auto;
    }
    h2 {
      margin-top: 0;
    }
    .options {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .option-button {
      padding: 1rem;
      border: none;
      border-radius: 8px;
      background-color: #ffffff22;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .option-button:hover {
      background-color: #ffffff44;
    }
    .feedback {
      margin-top: 1rem;
      font-weight: bold;
    }
    .next-button {
      margin-top: 2rem;
      padding: 1rem 2rem;
      font-size: 1rem;
      background-color: #ff4081;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .next-button:hover {
      background-color: #ff79a7;
    }
    .no-questions {
      text-align: center;
      padding: 2em 0;
      color: #ffeea8;
      font-size: 1.2em;
    }
    .badge {
      display: inline-block;
      background: #ffe082;
      color: #222;
      border-radius: 1em;
      padding: 0.2em 0.8em;
      margin-bottom: 0.5em;
      font-size: 0.9em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="question-container" id="qcontainer">
    <div id="modalitat-badge"></div>
    <h2 id="tema"></h2>
    <p id="pregunta"></p>
    <div class="options" id="opcions"></div>
    <div id="feedback" class="feedback"></div>
    <button class="next-button" id="nextBtn" onclick="seguentPregunta()">Seg√ºent pregunta</button>
  </div>

  <script>
    // -------------- CONFIGURACI√ì MODALITATS/JSONS --------------
    const MODALITAT_ARXIU = {
      "teoria": "preguntes_teoria.json",
      "terminologia": "preguntes_terminologia.json",
      "audicions": "preguntes_audicions.json"
    };

    // -------------- RECUPERA SELECCI√ì DE L'USUARI --------------
    const temesSeleccionats = JSON.parse(localStorage.getItem('temesSeleccionats') || "[]");
    const modalitatsSeleccionades = JSON.parse(localStorage.getItem('modalitatsSeleccionades') || "[]");

    // Si no hi ha selecci√≥, mostra error i atura
    if (!temesSeleccionats.length || !modalitatsSeleccionades.length) {
      document.getElementById("qcontainer").innerHTML = `
        <div class="no-questions">
          <p>‚ùó No s'han seleccionat temes o modalitats.</p>
          <p>Si us plau, torna a la p√†gina anterior i fes la selecci√≥.</p>
        </div>
      `;
    } else {
      // Filtra nom√©s les modalitats v√†lides (que existeixen a MODALITAT_ARXIU)
      const modalitatsValidades = modalitatsSeleccionades.filter(m => MODALITAT_ARXIU[m]);
      if (!modalitatsValidades.length) {
        document.getElementById("qcontainer").innerHTML = `
          <div class="no-questions">
            <p>‚ùó Cap modalitat seleccionada no √©s v√†lida.</p>
            <p>Si us plau, torna a la p√†gina anterior i fes una selecci√≥ correcta.</p>
          </div>
        `;
      } else {
        // Carrega totes les preguntes de cada modalitat seleccionada v√†lida
        Promise.all(
          modalitatsValidades
            .map(m => MODALITAT_ARXIU[m])
            .map(path => fetch(path).then(r => {
              if (!r.ok) throw new Error(`Error carregant ${path}`);
              return r.json();
            }))
        )
        .then(modalitatPreguntesArrays => {
          // Aplana totes les preguntes de totes les modalitats
          let preguntes = modalitatPreguntesArrays.flat();
          // Filtra pels temes seleccionats
          preguntes = preguntes.filter(p => temesSeleccionats.includes(p.temaId));
          if (!preguntes.length) {
            document.getElementById("qcontainer").innerHTML = `
              <div class="no-questions">
                <p>‚ùó No hi ha preguntes per aquesta selecci√≥ de temes i modalitats.</p>
                <p>Si us plau, torna enrere i selecciona altres opcions.</p>
              </div>
            `;
            return;
          }

          // Barreja preguntes i opcions
          barrejarArray(preguntes);
          preguntes = preguntes.map(p => {
            const opcions = [...p.opcions];
            const respostaCorrecta = opcions[p.correcta];
            barrejarArray(opcions);
            return {
              tema: p.tema,
              modalitat: p.modalitat || getModalitatDePregunta(p),
              pregunta: p.pregunta,
              opcions: opcions,
              correcta: opcions.indexOf(respostaCorrecta)
            };
          });

          function getModalitatDePregunta(pregunta) {
            // Intenta deduir modalitat a partir de la font (si vols)
            if (pregunta && pregunta.arxiuFont) return pregunta.arxiuFont.replace('preguntes_','').replace('.json','');
            return '';
          }

          let index = 0;
          let encerts = 0;
          let errors = 0;
          let respostaMostrada = false;

          function barrejarArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
            }
          }

          function carregarPregunta() {
            if (!preguntes[index]) {
              document.getElementById("qcontainer").innerHTML = `
                <div class="no-questions">
                  <p>‚ùó No hi ha m√©s preguntes.</p>
                </div>
              `;
              return;
            }
            const actual = preguntes[index];
            document.getElementById("modalitat-badge").innerHTML = actual.modalitat ? `<span class="badge">${capitalitza(actual.modalitat)}</span>` : "";
            document.getElementById("tema").textContent = actual.tema || '';
            document.getElementById("pregunta").textContent = "Pregunta: " + (actual.pregunta || '');
            document.getElementById("opcions").innerHTML = "";
            document.getElementById("feedback").textContent = "";
            respostaMostrada = false;

            actual.opcions.forEach((opcio, i) => {
              const boto = document.createElement("button");
              boto.className = "option-button";
              boto.textContent = opcio;
              boto.onclick = () => comprovarResposta(i);
              document.getElementById("opcions").appendChild(boto);
            });

            document.getElementById("nextBtn").style.display = "block";
          }

          function capitalitza(text) {
            return text.charAt(0).toUpperCase() + text.slice(1);
          }

          function comprovarResposta(seleccio) {
            if (respostaMostrada) return;
            respostaMostrada = true;
            const correcta = preguntes[index].correcta;
            const feedback = document.getElementById("feedback");
            if (seleccio === correcta) {
              feedback.textContent = "‚úÖ Correcte!";
              feedback.style.color = "#00ff88";
              encerts++;
            } else {
              feedback.textContent = "‚ùå Incorrecte. La resposta correcta era: " + preguntes[index].opcions[correcta];
              feedback.style.color = "#ff8888";
              errors++;
            }
          }

          window.seguentPregunta = function() {
            if (index < preguntes.length - 1) {
              index++;
              carregarPregunta();
            } else {
              document.getElementById("qcontainer").innerHTML = `
                <h2>Has completat totes les preguntes! üéâ</h2>
                <p>‚úÖ Correctes: ${encerts}</p>
                <p>‚ùå Incorrectes: ${errors}</p>
                <button class="next-button" onclick="window.location.href='modalitats.html'">Tornar a escollir modalitat</button>
              `;
            }
          };

          carregarPregunta();
        })
        .catch(err => {
          document.getElementById("qcontainer").innerHTML = `
            <div class="no-questions">
              <p>‚ùó Error carregant preguntes: ${err.message}</p>
            </div>
          `;
        });
      }
    }
  </script>
</body>
</html>
